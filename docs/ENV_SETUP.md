# Настройка переменных окружения (.env)

## Быстрый старт

**На сервере** (после `git pull`):

```bash
# 1. Скопировать файл-пример (в репозитории есть env.example без секретов)
cp env.example .env

# 2. Отредактировать .env и подставить свои значения
nano .env

# 3. Заполнить обязательные переменные (см. ниже)
```

**Важно:** В git пушится только `env.example` (шаблон без паролей). Файл `.env` в `.gitignore` — его не коммитить. На каждом сервере свой `.env` с реальными ключами и паролями.

---

## Обязательные переменные

### 1. Database (PostgreSQL)

```env
POSTGRES_USER=boats
POSTGRES_PASSWORD=boats2026secret  # Смените на сложный пароль!
POSTGRES_DB=boats2026
DATABASE_URL=postgresql://boats:boats2026secret@postgres:5432/boats2026?schema=public
```

Генерация безопасного пароля:

```bash
openssl rand -base64 32
```

### 2. Admin Panel

```env
ADMIN_PASSWORD=admin2026  # Смените на сложный пароль!
```

Этот пароль используется для входа в админ-панель (`/admin`).

---

## Telegram Bot

### Шаг 1: Создать/найти бота

#### Если бота нет:

1. Откройте Telegram
2. Найдите @BotFather
3. Отправьте `/newbot`
4. Следуйте инструкциям:
   - Имя бота: `Яхты Сочи`
   - Username: `YachtsSochiBot` (или свой уникальный)
5. **Скопируйте токен** (формат: `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`)

#### Если бот уже есть:

1. Откройте @BotFather
2. Отправьте `/mybots`
3. Выберите вашего бота
4. Нажмите **API Token**

### Шаг 2: Заполнить переменные

```env
# Токен от @BotFather
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# Username бота БЕЗ символа @
TELEGRAM_BOT_USERNAME=YachtsSochiBot
```

### Шаг 3: Получить Admin Chat ID

**Вариант А: Личный ID**

1. Откройте Telegram
2. Найдите бота @userinfobot
3. Нажмите **Start**
4. Бот ответит вашим ID (число, например `123456789`)

**Вариант Б: ID группы** (для командных уведомлений)

1. Создайте группу в Telegram
2. Добавьте в неё @RawDataBot
3. Бот покажет информацию, найдите `"chat":{"id":-1001234567890}`
4. Скопируйте число (с минусом!)

```env
# Личный ID или ID группы
TELEGRAM_ADMIN_CHAT_ID=123456789
```

### Шаг 4: Webhook Secret

Сгенерируйте случайную строку:

```bash
openssl rand -hex 32
```

```env
TELEGRAM_WEBHOOK_SECRET=сгенерированная_строка
```

---

## n8n Configuration

### Логин и пароль для n8n UI

```env
N8N_USER=admin
N8N_PASSWORD=admin2026  # Смените на сложный пароль!
```

После деплоя n8n будет доступен: `https://n8n.v-more.ru`

### API Key (опционально)

Для прямого доступа к n8n API:

```bash
openssl rand -hex 32
```

```env
N8N_API_KEY=сгенерированный_ключ
```

### Исходящий прокси для n8n (опционально)

Если n8n на сервере в РФ не может достучаться до Google (Gemini API), можно направить **только исходящий трафик n8n** через HTTP(S)-прокси. Сайт и остальные сервисы прокси не используют.

1. Купите HTTP(S)-прокси у любого провайдера (Европа/США). Обычно дают строку вида:  
   `http://логин:пароль@хост:порт`
2. В `.env` на сервере добавьте (подставьте свои данные):

```env
# Один и тот же URL для HTTP и HTTPS
N8N_HTTP_PROXY=http://логин:пароль@хост:порт
# Или отдельно:
# N8N_HTTPS_PROXY=http://логин:пароль@хост:порт
```

3. Перезапустите только n8n:

```bash
docker compose up -d n8n
```

Если переменные не заданы, n8n работает без прокси (как раньше). В пароле не должно быть неэкранированных `@`, `#`, `:` — при необходимости закодируйте их (percent-encoding) или возьмите готовую строку из личного кабинета провайдера.

---

## OpenRouter (AI для умных уведомлений)

OpenRouter предоставляет доступ к GPT-4o-mini и другим AI моделям.

### Получить API ключ:

1. Перейдите на https://openrouter.ai/keys
2. Войдите (через Google, GitHub или email)
3. Нажмите **Create Key**
4. Дайте имя ключу: `Boats2026 Production`
5. **Скопируйте ключ** (формат: `sk-or-v1-...`)
6. Пополните баланс (минимум $5-10 для начала)

```env
OPENROUTER_API_KEY=sk-or-v1-ваш_ключ_здесь
```

### Стоимость использования:

- GPT-4o-mini: ~$0.15 за 1M токенов ввода, ~$0.60 за 1M токенов вывода
- Одно напоминание ≈ 300-500 токенов ≈ $0.0005
- 100 уведомлений в день ≈ $1.50/месяц

---

## Проверка конфигурации

После заполнения `.env` проверьте корректность:

```bash
# На локальной машине
bash scripts/check-config.sh

# На сервере (после git pull)
bash scripts/check-config.sh
```

Скрипт проверит наличие всех обязательных переменных.

---

## Применение конфигурации на сервере

### 1. Создать .env на сервере

```bash
# SSH на сервер
ssh root@193.42.127.120

# Перейти в папку проекта
cd /root/segaboats

# Скопировать пример
cp env.example .env

# Отредактировать
nano .env
```

### 2. Заполнить переменные

Используйте инструкции выше для получения:
- TELEGRAM_BOT_TOKEN
- TELEGRAM_ADMIN_CHAT_ID
- OPENROUTER_API_KEY

### 3. Перезапустить контейнеры

```bash
# Проверить конфигурацию
bash scripts/check-config.sh

# Перезапустить
docker compose up -d --build
```

---

## Troubleshooting

### "TELEGRAM_BOT_TOKEN не установлен"

Проверьте:
1. Файл `.env` существует
2. Строка `TELEGRAM_BOT_TOKEN=...` не закомментирована (#)
3. Нет пробелов вокруг `=`
4. Токен скопирован полностью

### "TELEGRAM_ADMIN_CHAT_ID не установлен"

1. Напишите @userinfobot
2. Скопируйте ID **только число**, без других символов
3. Если ID группы - скопируйте с минусом: `-1001234567890`

### n8n не отправляет уведомления

1. Проверьте что `TELEGRAM_BOT_TOKEN` в `.env` совпадает с токеном бота
2. Убедитесь что переменная передана в контейнер:
   ```bash
   docker exec boats2026-n8n printenv | grep TELEGRAM
   ```

### OpenRouter API не работает

1. Проверьте баланс на https://openrouter.ai/activity
2. Проверьте что ключ активен
3. Убедитесь что ключ начинается с `sk-or-v1-`

---

## Безопасность

**ВАЖНО:** Никогда не коммитьте файл `.env` в git!

Файл `.env` находится в `.gitignore` и не должен попадать в репозиторий.

Храните резервную копию `.env` в безопасном месте (не в git).
