#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Docker –∏ Docker Compose –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä

set -e

echo "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∏ Docker Compose..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then 
  echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç root: sudo ./scripts/install-docker.sh"
  exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–∞–∫–µ—Ç–æ–≤..."
apt-get update

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ GPG –∫–ª—é—á–∞ Docker
echo "üîë –î–æ–±–∞–≤–ª–µ–Ω–∏–µ GPG –∫–ª—é—á–∞ Docker..."
mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
echo "üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è Docker..."
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Engine
echo "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Engine..."
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# –ó–∞–ø—É—Å–∫ Docker
echo "‚ñ∂Ô∏è  –ó–∞–ø—É—Å–∫ Docker..."
systemctl start docker
systemctl enable docker

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
docker --version
docker compose version

echo ""
echo "‚úÖ Docker –∏ Docker Compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):"
echo "   sudo usermod -aG docker $USER"
echo "   newgrp docker"
echo ""
echo "2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–µ—Å–ª–∏ –∑–∞–ø—É—â–µ–Ω—ã):"
echo "   sudo systemctl stop nginx"
echo "   sudo systemctl stop pm2"
echo "   sudo systemctl disable nginx"
echo "   sudo systemctl disable pm2"
echo ""
echo "3. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):"
echo "   sudo apt-get remove -y nginx nodejs npm pm2"
echo "   sudo apt-get autoremove -y"
